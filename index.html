<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>جميع قنوات IPTV</title>
  <style>
    body { font-family: sans-serif; direction: rtl; padding: 20px; }
    h1 { text-align: center; }
    #channels { list-style: none; padding: 0; }
    #channels li { margin: 8px 0; }
    .channel-link { text-decoration: none; color: #0066cc; cursor: pointer; }
    .channel-link:hover { text-decoration: underline; }
    #player { width: 100%; max-width: 720px; height: 405px; margin: 20px auto; display: block; background: #000; }
  </style>
  <!-- مكتبة hls.js لتشغيل HLS على جميع المتصفحات -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>

  <h1>جميع قنوات IPTV</h1>
  <video id="player" controls></video>
  <ul id="channels">
    <li>جارٍ تحميل القنوات، انتظر لحظة...</li>
  </ul>

  <script>
    const primaryAPI  = 'https://info.iptv2022.com/api/getPlaylist';
    const fallbackAPI = 'https://pl.iptv2021.com/api/getPlaylist';
    const listEl      = document.getElementById('channels');
    const player      = document.getElementById('player');

    // تحميل القنوات من API معيّن
    async function fetchChannels(api) {
      const res = await fetch(api, { headers: { 'Accept': 'application/json' } });
      if (!res.ok) throw new Error(`API failed: ${res.status}`);
      const { data } = await res.json();
      return data.channels;
    }

    // المحاولة الأوليّة ثم الاحتياطيّة
    async function loadAllChannels() {
      try {
        return await fetchChannels(primaryAPI);
      } catch (e1) {
        console.warn('الرئيسي فشل:', e1);
        try {
          return await fetchChannels(fallbackAPI);
        } catch (e2) {
          console.error('الاحتياطي فشل:', e2);
          throw new Error('تعذر جلب قائمة القنوات من كلا الخادمين');
        }
      }
    }

    // عرض كل القنوات
    function render(channels) {
      listEl.innerHTML = '';
      channels.forEach(ch => {
        const li = document.createElement('li');
        const a  = document.createElement('a');
        a.textContent = ch.name;
        a.className   = 'channel-link';
        a.dataset.url = ch.stream_url;
        a.onclick = () => play(ch.stream_url);
        li.appendChild(a);
        listEl.appendChild(li);
      });
    }

    // تشغيل قناة
    function play(url) {
      if (Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(player);
        hls.on(Hls.Events.MANIFEST_PARSED, () => player.play());
      } else if (player.canPlayType('application/vnd.apple.mpegurl')) {
        player.src = url;
        player.play();
      } else {
        alert('المتصفح لا يدعم HLS.');
      }
    }

    // تنفيذ
    loadAllChannels()
      .then(render)
      .catch(err => {
        listEl.innerHTML = `<li style="color:red;">${err.message}</li>`;
      });
  </script>

</body>
</html>