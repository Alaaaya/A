<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>قائمة قنوات IPTV</title>
  <style>
    body { font-family: sans-serif; direction: rtl; padding: 20px; }
    h1 { text-align: center; }
    #channels { list-style: none; padding: 0; }
    #channels li { margin: 10px 0; }
    .channel-link { text-decoration: none; color: #0066cc; }
    .channel-link:hover { text-decoration: underline; }
    #player { width: 100%; max-width: 640px; margin: 20px auto; display: block; }
  </style>
  <!-- تضمين مكتبة hls.js لتشغيل HLS في المستعرضات التي لا تدعم الفيديو مباشرة -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>

  <h1>قائمة قنوات IPTV</h1>
  <video id="player" controls></video>
  <ul id="channels">
    <li>جارٍ تحميل القنوات…</li>
  </ul>

  <script>
    const primaryAPI    = 'https://info.iptv2022.com/api/getPlaylist';
    const fallbackAPI   = 'https://pl.iptv2021.com/api/getPlaylist';
    const player        = document.getElementById('player');
    const listContainer = document.getElementById('channels');

    // دالة لتحميل قائمة القنوات من خادم معيّن
    async function loadChannels(apiUrl) {
      const res = await fetch(apiUrl, { headers: { Accept: 'application/json' } });
      if (!res.ok) throw new Error('API error ' + res.status);
      const json = await res.json();
      return json.data.channels;
    }

    // محاولة جلب القنوات من الرئيسي ثم الاحتياطي
    async function init() {
      try {
        const channels = await loadChannels(primaryAPI);
        renderChannelList(channels);
      } catch (e) {
        console.warn('الرئيسي فشل:', e);
        try {
          const channels = await loadChannels(fallbackAPI);
          renderChannelList(channels);
        } catch (e2) {
          console.error('الاحتياطي فشل:', e2);
          listContainer.innerHTML = '<li>تعذّر تحميل قائمة القنوات من كلا الخادمين.</li>';
        }
      }
    }

    // عرض القائمة في الصفحة
    function renderChannelList(channels) {
      listContainer.innerHTML = '';
      channels.forEach(ch => {
        const li = document.createElement('li');
        const a  = document.createElement('a');
        a.textContent = ch.name;
        a.href        = '#';
        a.className   = 'channel-link';
        a.dataset.url = ch.stream_url;
        a.onclick = e => {
          e.preventDefault();
          playStream(e.target.dataset.url);
        };
        li.appendChild(a);
        listContainer.appendChild(li);
      });
    }

    // تشغيل مسار HLS في عنصر الفيديو
    function playStream(url) {
      if (Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(player);
        hls.on(Hls.Events.MANIFEST_PARSED, () => player.play());
      } else if (player.canPlayType('application/vnd.apple.mpegurl')) {
        player.src = url;
        player.play();
      } else {
        alert('هذا المتصفح لا يدعم تشغيل HLS بشكل مباشر.');
      }
    }

    // بدء العملية
    init();
  </script>

</body>
</html>